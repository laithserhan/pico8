pico-8 cartridge // http://www.pico-8.com
version 18
__lua__
function make_cam(x,y,a)
	return {
		pos={x,y},
		angle=a,
	 project2d=function(self,x,y)
	 	return 64+x*8,64-y*8
	 end
	}
end

local actors={}
local cam=make_cam(0,0,0)

local dists={}
local angles={}
for i=0,127 do
	angles[i]=atan2(i-64,64)
	dists[i]=sqrt((i-64)*(i-64)+64*64)
end

function _init()
 for i=0,15 do
  for j=0,15 do
  	local s=mget(i,j)
   if fget(s)==4 then
   	add(actors,{
   	 pos={i+0.5,j+0.5},
   	 sx=(s*8)%128
   	})
   end
  end
 end
end

function _update()
	local dx,dy=0,0
	if(btn(2)) dx=1
	if(btn(3)) dx=-1
	if(btn(0)) dy=-1
	if(btn(1)) dy=1

	cam.angle+=dy/128
	local u,v=cos(cam.angle),-sin(cam.angle)
	cam.pos[1]+=dx*u/4
	cam.pos[2]+=dx*v/4
end

function solid(i,j)
	return fget(mget(i,j))==2
end

function wallhit(posx,posy,u,v,out)
 local mapx,mapy=flr(posx),flr(posy)
 local sidex,sidey
 local ddx,ddy=abs(1/u),abs(1/v)
 local mapdx,mapdy
 local distx,disty
 local hit=false
 local side=0
 if u<0 then
 	mapdx=-1
  distx=(posx-mapx)*ddx
 else
 	mapdx=1
  distx=(mapx+1-posx)*ddx
 end

 if v<0 then
 	mapdy=-1
  disty=(posy-mapy)*ddy
 else
 	mapdy=1
  disty=(mapy+1-posy)*ddy
 end

 local dist=0
 while hit==false and dist<20 do
		if distx<disty then
			distx+=ddx
			mapx+=mapdx
			side=u<0 and 1 or 0
		else
			disty+=ddy
			mapy+=mapdy
			side=2
		end
		local len=0
		if side!=2 then
			len=(mapx-posx+(1-mapdx)/2)/u
  else
   len=(mapy-posy+(1-mapdy)/2)/v			
		end
		if solid(mapx,mapy)==true then
			return true,mapx,mapy,side,len
		end
		-- non solid visible tiles
		out[mapx+32*mapy]={mapx,mapy}
		dist+=1
	end
end

function rot_inv(p,a)
 local c,s=cos(a),-sin(a)
 return {p[1]*c+p[2]*s,-p[1]*s+p[2]*c}
end

function _draw()
 cls()
 rectfill(0,64,127,127,5)
 
 palt(0,false)

 --
	local tiles={}
	local zbuf={}
 for i=0,127 do
 	local angle=angles[i]
 	local u,v=sin(angle+cam.angle),cos(angle+cam.angle)
 	
 	--[[
		local hit,x1,y1,leftright=lineofsight(cam.pos[1],cam.pos[2],cam.pos[1]+10*u,cam.pos[2]+10*v,10) 
		]]
		local hit,x1,y1,side,dist,tx=wallhit(cam.pos[1],cam.pos[2],u,v,tiles)
		
		-- 2d map
		if btn(5) then
   for i=0,16 do
   	for j=0,16 do
   	 if mget(i,j)!=0 then
   	 	local x,y=cam:project2d(i,j)
   			rectfill(x,y,x+8,y+8,1)
   		end
   	end
   end
   local xc,yc=cam:project2d(cam.pos[1],cam.pos[2])
  	pset(xc,yc,8)
 		if hit==true then
 	 	local x,y=cam:project2d(x1,y1)
 	 	rectfill(x,y,x+8,y+8,14)
 	 	-- front wall
 	 	if side==2 then
 	 		line(x,y+8,x+8,y+8,2)
 	 	else
 	 		side*=8
 	 		line(x+side,y,x+side,y+8,2)
 	 	 print(side,x+1,y+2,0)
 	 	end
  	 line(xc,yc,x,y,1)
  	end	
  else -- 3d map

   -- 
  	if hit==true then
				local h=dists[i]/dist
   	zbuf[i]=dist
   	local sx=16
   	if side!=2 then
    	tx=v*dist-cam.pos[2]
    	sx+=8    
    else
    	tx=u*dist-cam.pos[1]
    end
    tx=tx%1
    sspr(sx+tx*8,0,1,8,i,64-h/2,1,h)
   end
  end 		
	end

 -- actors
 palt(14,true)
 local drawables={}
 for _,a in pairs(actors) do
  local p=rot_inv({a.pos[1]-cam.pos[1],a.pos[2]-cam.pos[2]},cam.angle)
  if p[1]>0.1 then
	  local w=64/p[1]
  	add(drawables,{
  		x=64+w*p[2],
  		depth=p[1],
  		sx=a.sx,
  		key=-64/p[1],})
  end
 end
 
 sort(drawables)
 
 for _,a in pairs(drawables) do
  local w=-a.key
  -- assumes all actors to be 8x8
  local sx,dsx=a.sx,8/w
  local x0=a.x-w/2
  -- clip sprite start to 0
  if(x0<0) x0,sx=0,sx-dsx*x0
  for dx=flr(x0),min(127,flr(a.x+w/2-0.5)) do
			-- get wall distance
			local z=zbuf[dx] or 32000
			-- is slice visible
			if z>a.depth then
				sspr(sx,0,1,8,dx,64-w/2,1,w)
			end
		 sx+=dsx
		end
 end
 palt()
 
	local cpu=stat(1)
	print(cpu,2,3,5)
	print(cpu,2,2,7)
end

-->8
-- https://github.com/morgan3d/misc/tree/master/p8sort
function sort(data)
 for num_sorted=1,#data-1 do 
  local new_val=data[num_sorted+1]
  local new_val_key=new_val.key
  local i=num_sorted+1

  while i>1 and new_val_key>data[i-1].key do
   data[i]=data[i-1]   
   i-=1
  end
  data[i]=new_val
 end
end
__gfx__
00000000555555559991999944404444e000000ee000000ee000000e000000000000000000000000000000000000000000000000000000000000000000000000
000000005555555544914444224022220f66ff6001111a1002289890000000000000000000000000000000000000000000000000000000000000000000000000
007007005555555511111111000000000558585001c000000228a8a0000000000000000000000000000000000000000000000000000000000000000000000000
000770005555555599999199444440440ff66ff00ccc0c0002288880000000000000000000000000000000000000000000000000000000000000000000000000
0007700055555555444491442222402206ff66f00cccccc002276760000000000000000000000000000000000000000000000000000000000000000000000000
007007005555555511111111000000000f66f6600555565002268680000000000000000000000000000000000000000000000000000000000000000000000000
00000000555555559991999944404444e06f0ff00700007002000020000000000000000000000000000000000000000000000000000000000000000000000000
00000000555555554491444422402222ee00e00ee0eeee0e00eeee00000000000000000000000000000000000000000000000000000000000000000000000000
00000000015d67000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__label__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00777000007770700070707000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00757000005570700070707000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00707000000770777077707770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00707000000570757055707570000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00777007007770777000707770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00555005005550555000505550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000002222222222888888999998888899999900000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000002222222222888888999998888899999900000000000000000000000000000000000000000000000000000000000000
00091119999999999999999999990000002222222222888888999998888899999900000000000000000000000000000000000000000000000000000000000000
99991119999999999999999999990000002222222222888888999998888899999900000000000000000000000000000000000000000000000000000000000444
99991119999999999999999999990000002222222222888888999998888899999900000000000000000000000000000000000000000000000000000000444444
99991119999999999999999999990000002222222222888888999998888899999900000000000000000000000000000000000000000000000000000000444444
44441119994444444444444444440000002222222222888888aaaaa88888aaaaaa00000000000000000000000000000000000000000000000000000000444222
44441119994444444444444444440000002222222222888888aaaaa88888aaaaaa00000000000000000000000000000000000000000000000000000000222222
44441119994444444444444444440000002222222222888888aaaaa88888aaaaaa00000000000000000000000000000000000000000000000000000000222222
44411111111111111111111111110000002222222222888888aaaaa88888aaaaaa00000000000000000000000000000000000000000000000000000000222222
11111111111111111111111111110000002222222222888888aaaaa88888aaaaaa00000000000000000000000000000000000000000000000000000999000000
1111111111111111111111111111000000222222222288888888888888888888880000000011111111aa10000000000449999999199999999999919999000000
1111111111111111111111111111000000222222222288888888888888888888880000000011111111aa10000044440224444444199444444444419944000000
1999999999999999999999911199000000222222222288888888888888888888880000010011cc00000000004022220224444444199444444444419111444004
19999999999999999999999111990000002222222222888888888888888888888800000100cccccc00cc00002000000001111111111111111111111111444004
19999999999999999999999111990000002222222222888888888888888888888800000900cccccc00cc00000044444449999199999999999119999999444004
19994444444444449999999111990000002222222222777777666667777766666600000400ccccccccccc0004424442249999199999999999119999444224004
19994444444444444444444111990000002222222222777777666667777766666600000100ccccccccccc0000000220024444199444444444119944444222004
19994444444444444444444111990000002222222222777777666667777766666600000100555555556650004044000001111111111111111111111111222004
19994444444444444444444111990000002222222222777777666667777766666600000500555555556650002022440449999999199999999999919999002004
11111111111111111111111111110000002222222222777777666667777766666600000500770000000070005555220249999999199999999999919999000000
11111111111111111111111111110000002222222222666666888886666688888800000555005555555505505555555524444444199444444444419944000000
11111111111111111111111111110000002222222222666666888886666688888800000555005555555505505555555555555555555555555555555555440000
99991119999999991111111111110000002222222222666666888886666688888800000555555555555555555555555555555555555555555555555555444444
99991119999999999999999999990000002222222222666666888886666688888800000555555555555555555555555555555555555555555555555555444444
99991119999999999999999999990000002222222222666666888886666688888800000555555555555555555555555555555555555555555555555555224444
99991119999999999999999999990000002222222222666666888886666688888800000555555555555555555555555555555555555555555555555555222224
44441119994444444444444444440000002222200000000000000000000022222200000555555555555555555555555555555555555555555555555555222222
44441119994444444444444444440000002222200000000000000000000022222200000555555555555555555555555555555555555555555555555555552222
44441119994444444444444444440000002222200000000000000000000022222200000555555555555555555555555555555555555555555555555555555552
55555555555555554444444444440000002222200000000000000000000022222200000555555555555555555555555555555555555555555555555555555555
55555555555555555555555555550000002222200000000000000000000022222200000555555555555555555555555555555555555555555555555555555555
55555555555555555555555555550000000000055555555555555555555500000000000555555555555555555555555555555555555555555555555555555555
55555555555555555555555555550000000000055555555555555555555500000000000555555555555555555555555555555555555555555555555555555555
55555555555555555555555555550000000000055555555555555555555500000000000555555555555555555555555555555555555555555555555555555555
55555555555555555555555555550000000000055555555555555555555500000000000555555555555555555555555555555555555555555555555555555555
55555555555555555555555555550000000000055555555555555555555500000000000555555555555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555

__gff__
0002000004040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0000000000010000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000010101000000010000060001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000001000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000400010001000006000000010001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000010001000000010101010001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000010000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000050000010000000500000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000040001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101000000000101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000001000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000001000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000001060000060100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000001010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
